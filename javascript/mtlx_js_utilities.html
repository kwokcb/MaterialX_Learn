<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Authors: Bernard Kwok and Matthew Kwok. Resource site for the
  Academy Software Foundation MaterialX -- an open source industry standard for 3D / Cg materials.
  Resources include interaction with related standards: OpenUSD, Khronos glTF, OpenImageIO.">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J7404418VP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-J7404418VP');
  </script>

  <style>
    model-viewer {
      width: 256px;
      height: 256px;
      background-color: #7d7d7d;
    }
  </style>

  <!-- <link rel="icon" href="../documents/images/logo3d_icon.png" type="image/x-icon" /> -->
  <!--
  <link rel="icon" href="../documents/images/logo3d_2_small.png" type="image/x-icon" />
  -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.0/css/brands.min.css"> 

  <link rel="stylesheet" href="../documents/css/style.css">

  <!-- 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  -->

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/night.min.css">

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/abbott.min.css">
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/json/json.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>

    <script src="JsMaterialXGraph.js" type="text/javascript"></script>

    <style>
        .inverted-svg {
            filter: invert(1);
        }

        .CodeMirror {
            font-size: 12px;
            border: solid thin lightskyblue;
        }
    </style>


  <title>MaterialX Learn</title>
  <link rel="icon" type="images" href="../documents/images/logo3d_icon.png" type="image/x-icon" class="img-fluid">

</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>
  <script src="../documents/js/ui_helpers.js"></script>
  
  </script>  
   
  <!-- Navigation_Area-->
<nav class="navbar sticky-top navbar-expand-lg bg-dark-subtle" data-bs-theme="dark">
    <div class="container-md container-fluid">
        <a class="navbar-brand" href="../index.html">
            <h5><img src="../documents/images/logo3d_2_small.png" alt="MaterialX Learn"
                    class="rounded d-inline-block align-text-center" width="50px">
                MaterialX Learn</h5>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainMenuContent"
            aria-controls="mainMenuContent" aria-expanded="false" aria-label="Toggle top menu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainMenuContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a class="nav-link" href="../index.html" role="button">
                        Home
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Learn
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="../documents/nodes_and_nodegraphs.html">
                                Nodes and Graphs
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="../documents/node_definitions.html">
                                Node Definitions
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="../documents/documents.html">
                                Documents
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="../documents/presentations.html">
                                Presentations and Media
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                        data-bs-auto-close="outside">Reference</a>
                    <ul class="dropdown-menu shadow">
                        <li><a class="dropdown-item"
                                href="../documents/definitions/definitions_by_group.html">Library
                                (By Group)</a></li>
                        <li><a class="dropdown-item"
                                href="../documents/definitions/all_definitions.html">Library
                                (All)</a></li>
                        <li><a class="dropdown-item"
                                href="../documents/definitions/library_glossary.html">Library
                                Glossary</a></li>
                        <li><a class="dropdown-item" href="https://materialx.org/docs/api/annotated.html"
                                target="_blank"><img src="../documents/images/MaterialXLogo_200x155.png"
                                    style="width:20px"> C++ API</a></li>

                        <li class="dropend">
                            <a href="#" class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown">Library
                                Revisions</a>
                            <ul class="dropdown-menu shadow">
                                <li><a class="dropdown-item" href="../documents/mtlx_1389_vs_1390.html">
                                        1.38.9 vs 1.39.0</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1388_vs_1389.html">
                                        1.38.8 vs 1.38.9</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1387_vs_1388.html">
                                        1.38.7 vs 1.38.8</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1386_vs_1387.html">
                                        1.38.6 vs 1.38.7</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1385_vs_1386.html">
                                        1.38.5 vs 1.38.6</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1384_vs_1385.html">
                                        1.38.4 vs 1.38.5</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1383_vs_1384.html">
                                        1.38.3 vs 1.38.4</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1382_vs_1383.html">
                                        1.38.2 vs 1.38.3</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1381_vs_1382.html">
                                        1.38.1 vs 1.38.2</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1380_vs_1381.html">
                                        1.38.0 vs 1.38.1</a></li>
                                <li><a class="dropdown-item" href="../documents/mtlx_1380_vs_1390.html">
                                        1.38.0 vs 1.39.0</a></li>
                            </ul>
                        </li>

                        <div class="dropdown-divider"></div>
                        <li>
                            <a class="dropdown-item" href="../documents/using_library.html">
                                <img src="../documents/images/info-circle.svg"> Library User Guide
                            </a>
                        </li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                        aria-expanded="false">Utilities</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="../documents/gltfViewer.html">glTF Model Viewer</a></li>
                        <li><a class="dropdown-item" href="../documents/mermaidChecker.html">Graph Visualizer</a></li>
                        <li><a class="dropdown-item" href="../javascript/mtlx_js_utilities.html">Graph Editing</a></li>
                        <li><a class="dropdown-item" href="../javascript/viewer/dist/index_out.html">Shader Preview</a></li>
                        <li><a class="dropdown-item" href="../documents/mtlx_utilities.html">Python Utilities</a></li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                        aria-expanded="false">Develop</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="../documents/python_MaterialX.html">Notebooks</a></li>
                        <li><a class="dropdown-item" href="../documents/jupyter_example.html">Examples</a></li>
                        <li><a class="dropdown-item" href="../documents/hosting.html">Hosting</a>
                        </li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                        aria-expanded="false">Workflows</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="../documents/workflow_usd.html">USD and MaterialX</a></li>
                        <li><a class="dropdown-item" href="../documents/workflow_gltf.html">glTF and MaterialX</a></li>
                        <li><a class="dropdown-item" href="../documents/workflow_ocio.html">OCIO and MaterialX</a></li>
                    </ul>
                </li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                        aria-expanded="false">Design</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="../documents/design.html">UX Design</a></li>
                        <li><a class="dropdown-item" href="../documents/property_editor_ui.html">Property Editor UX</a></li>
                        <li><a class="dropdown-item" href="https://guannan-kwok.github.io/assetLibrary/materialx/" target="_blank">Graphic Design</a></li>
                        <li><a class="dropdown-item" href="../documents/implementation.html">Implementation</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../documents/about.html" role="button">
                        About
                    </a>
                </li>
                <!--INDEX_ITEM-->
            </ul>
        </div>
    </div>
</nav>

  <!-- Section Information -->
  <section class="py-0 px-0 g-0">
    <div class="container-fluid p-4">
          <div class="container-fluid p-4">
        <h2>Graph Utilities</h2>

        <p>The following is a set of graph related utilities to work with MaterialX using it's Javascript
            packages. Specifically only the <b>JsMaterialXCore</b> package is used as it is much
            more lightweight than the the full MaterialX package which includes shader generation.
        </p>
        The utilities collected together into a
        <b>materialxgraph</b> package which can be reused in other projects. Currently the package includes:
        <ul>
            <li>A class which allows for the extraction of node, graph and connectivity information into a MaterialX
                independent format. This can be serialized to JSON for further processing.
            </li>
            <li>A class that can consume the JSON connectivity information and construct Mermaid graphs.</li>
        </ul>
        </p>

        <p>Using this package, a MaterialX file can be loaded in and previewed as text or visualized as a "Mermaid"
            graph.
            The separate <a href="../documents/mermaidChecker.html">Mermaid Visualizer</a> can also be used.
            It uses the same <b>JsMaterialXGraph</b> package.
            Additionally, the node and connectively information
        </p>
        <p>
            A simple MaterialX graph is loaded in by default.
        </p>
        <button class="btn btn-outline-primary shadow" id="loadMaterialXButton">Load MaterialX Document</button>
        <button class="btn btn-sm copy-button" data-target="materialXTextArea">
            <img class="" src="../documents/images/copy-regular.svg" style="width: 24px; height: 24px" alt="Copy Icon">
        </button>
        <button id="materialXTextArea_paste" class="btn btn-sm" data-target="materialXTextArea">
            <img class="" src="../documents/images/clipboard_white.svg" style="width: 24px; height: 24px" alt="Copy Icon">
        </button>
        <div class="row ">
            <div class="col-12 p-2">
                <textarea class="form-control form-control-sm" data-bs-theme="dark" id="materialXTextArea" rows="15"
                    style="width: 100%; " placeholder="Loaded MaterialX document will be displayed here"
                    value='<?xml version="1.0" encoding="utf-8"?>\r\n<materialx version="1.38" colorspace="lin_rec709">\r\n</materialx>'>
                </textarea>
            </div>
        </div>

        <hr>

        <!-- Button to generate graph -->
        <details open>
            <summary class="fs-3">Graph Connectivity</summary>
            <p></p>
            <div class="row">
                <div class="col-2">
                    <button class="btn btn-outline-primary shadow" id="generateGraphButton">Generate Graph</button>
                </div>
                <div class="col-10 border-start">
                    <label for="graphOrientation">Graph Orientation:</label>
                    <select id="graphOrientation">
                        <option value="0">Left to Right</option>
                        <option value="1">Top to Bottom</option>
                    </select>
                    <!-- Show node categories or node names -->
                    <div class="form-check">
                        <label class="form-check-label" for="graphOptions">
                            Label Nodes with Categories
                        </label>
                        <input class="form-check-input" type="checkbox" value="" id="labelCategories">
                        </input>
                    </div>
                    <!-- Show node types -->
                    <div class="form-check">
                        <label class="form-check-label" for="graphOptions">
                            Label Nodes with Types
                        </label>
                        <input class="form-check-input" type="checkbox" value="" id="labelTypes">
                        </input>
                    </div>
                </div>
            </div>
            <div class="row d-flex">
                <div class="col">
                    <b>Connectivity</b>
                    <button class="btn btn-sm copy-button" data-target="json_output">
                        <img class="" src="../documents/images/copy-regular.svg" style="width: 16px; height: 16px"
                            alt="Copy Icon">
                    </button>
                    <textarea id="json_output" class="form-control form-control-sm" data-bs-theme="dark" rows="10"
                        style="width: 100%; border:solid thin lightskyblue; background-color: #000000"
                        placeholder="Generated JSON information will be displayed here"></textarea><br>
                </div>
                <div class="col">
                    <b>Mermaid</b>
                    <button class="btn btn-sm copy-button" data-target="mermaid_input">
                        <img class="" src="../documents/images/copy-regular.svg" style="width: 16px; height: 16px"
                            alt="Copy Icon">
                    </button>
                    <textarea id="mermaid_input" class="form-control form-control-sm" data-bs-theme="dark" rows="10"
                        style="width: 100%; border:solid thin lightskyblue; background-color: #000000"
                        placeholder="Generated Mermaid Graph will be displayed here"></textarea><br>
                </div>
            </div>

            <div class="row pb-2">
                <div class="col-12">
                    <label for="mermaid_output"><b>Graph</b></label>
                    <div id="mermaid_output" class="mermaid_output rounded" style="border:solid thin lightskyblue">
                        <!-- An svg element called "mermaid_output_rendered" will be inserted on render -->
                    </div>
                </div>
            </div>
            <div class="row ">
                <div class="col-12">
                    <button id="saveSVG" class="btn btn-outline-primary shadow-sm">Save SVG</button>
                    <button id="resetSVGView" class="btn btn-outline-primary shadow-sm">Reset View</button>
                </div>
            </div>

        </details>
        <hr>

        <details open>
            <summary class="fs-3">Graph Definitions</summary>
            <p></p>

            <div class="row pb-2 border-bottom p-2">
                <div class="col">
                    <button class="btn btn-outline-primary shadow" id="updateGraphs">Node Graph</button>
                </div>
                <div class="col-10 border-start">
                    <select id="nodeGraphs">
                    </select>
                </div>
            </div>
            <div class="row p-2">
                <div class="col">
                    <button class="btn btn-outline-primary shadow" id="createDefinition">Create Definition</button>
                    <button class="btn btn-outline-primary shadow" id="saveDefinition">Save Definition</button>
                </div>
                <div class="col-10 border-start">

                    <div class="row">
                        <div class="col p-2">
                            <label for="definitionName">Definition Category</label>
                            <input type="text" id="definitionName" placeholder="Set definition category."
                                style="border:solid thin lightskyblue">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col p-2">
                            <label for="nodegroupName">Node Group</label>
                            <input type="text" id="nodegroupName" value="procedural" placeholder="procedural"
                                style="border:solid thin lightskyblue">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col p-2">
                            <label for="documentationString">Documentation</label>
                            <textarea id="documentationString" class="form-control form-control-sm" data-bs-theme="dark"
                                rows="1" style="border:solid thin lightskyblue; background-color: #000000"
                                placeholder="Add definition documentation."></textarea><br>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col p-0">
                    <label for="definition_output"><b>Functional Graph</b></label>
                    <button class="btn btn-sm copy-button" data-target="definition_output">
                        <img class="" src="../documents/images/copy-regular.svg" style="width: 16px; height: 16px"
                            alt="Copy Icon">
                    </button>
                    <textarea id="definition_output" class="form-control form-control-sm" data-bs-theme="dark" rows="10"
                        style="border:solid thin lightskyblue"
                        placeholder="Generated definition will be displayed here"></textarea><br>
                </div>
            </div>
            <div class="row">
                <div class="col p-0">
                    <label for="definition_output2"><b>Node Definition</b></label>
                    <button class="btn btn-sm copy-button" data-target="definition_output2">
                        <img class="" src="../documents/images/copy-regular.svg" style="width: 16px; height: 16px"
                            alt="Copy Icon">
                    </button>
                    <textarea id="definition_output2" class="form-control form-control-sm" data-bs-theme="dark" rows="5"
                        style="border:solid thin lightskyblue"
                        placeholder="Generated definition will be displayed here"></textarea><br>
                </div>
            </div>

        </details>

        <script src="JsMaterialXCore.js" type="text/javascript"></script>
        <script type="text/javascript">
            console.log("Load MaterialX...");

            var mx = null;
            var doc = null;
            var editor = null;
            var defeditor = null;
            var defeditor2 = null;

            function loadMaterialX() {
                return new Promise((resolve, reject) => {
                    MaterialX().then((mtlx) => {
                        // Save the MaterialX instance to the global variable
                        mx = mtlx;
                        /*
                        console.log("MaterialX loaded", mx);
                        for (var key in mtlx) {
                            if (Object.hasOwnProperty.call(mtlx, key)) {
                                var func = mtlx[key];
                                console.log(key, func);
                                }
                            }
                        } */
                        resolve();
                    }).catch((error) => {
                        reject(error);
                    });
                });
            }

            // Call the asynchronous function and then perform additional logic
            loadMaterialX().then(() => {
                // Additional logic after MaterialX is loaded
                doc = mx.createDocument();
                loadDefaultMaterialxDocument(1);
                console.log("MaterialX is loaded");
            }).catch((error) => {
                console.error("Error loading MaterialX:", error);
            });

            // Attach event listener to the button
            document.getElementById('loadMaterialXButton').addEventListener('click', () => {
                // Open file dialog
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.mtlx';
                input.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        loadMaterialXDocument(file, file.name);
                    }
                });

                // Trigger the file dialog
                input.click();
            });

            function loadDefaultMaterialxDocument(index) {
                if (!doc) {
                    console.error("MaterialX document is not initialized");
                    return;
                }
                let defaultDocs = [];
                defaultDocs[0] = `<?xml version="1.0"?>
<materialx version="1.38" colorspace="lin_rec709">
  <surfacematerial name="surfacematerial" type="material" xpos="17.246376" ypos="-15.689655">
    <input name="surfaceshader" type="surfaceshader" nodename="surface_unlit" />
  </surfacematerial>
  <input name="input_color3" type="color3" value="0, 0, 1" xpos="10.905797" ypos="-15.982759" />
  <surface_unlit name="surface_unlit" type="surfaceshader" xpos="14.231884" ypos="-16.241379">
    <input name="emission_color" type="color3" interfacename="input_color3" />
  </surface_unlit>
</materialx>`;

                defaultDocs[1] = `<?xml version="1.0"?>
<materialx version="1.38">
  <nodegraph name="sep_combine">
    <output name="output_color3" type="color3" xpos="7.021739" ypos="-4.482759" nodename="combine3_color3" />
    <separate3 name="separate3_color3" type="multioutput" xpos="1.826087" ypos="-4.655172">
      <output name="outr" type="float" />
      <output name="outg" type="float" />
      <output name="outb" type="float" />
      <input name="in" type="color3" interfacename="input_color3" />
    </separate3>
    <combine3 name="combine3_color3" type="color3" xpos="4.376812" ypos="-4.293103">
      <input name="in2" type="float" output="outr" nodename="separate3_color3" />
      <input name="in1" type="float" output="outb" nodename="separate3_color3" />
      <input name="in3" type="float" output="outg" nodename="separate3_color3" />
    </combine3>
    <input name="input_color3" type="color3" value="0.200836, 0.245866, 0.555012" xpos="-0.224638" ypos="-4.672414" />
  </nodegraph>
  <gltf_pbr name="gltf_pbr_surfaceshader" type="surfaceshader" xpos="6.768116" ypos="-7.681035">
    <input name="base_color" type="color3" output="output_color3" nodegraph="sep_combine" />
  </gltf_pbr>
  <surfacematerial name="surfacematerial" type="material" xpos="11.246377" ypos="-7.413793">
    <input name="surfaceshader" type="surfaceshader" nodename="gltf_pbr_surfaceshader" />
  </surfacematerial>
</materialx>
`;
                let xmlString = defaultDocs[index];

                (async () => {
                    try {
                        const readOptions = new mx.XmlReadOptions();
                        readOptions.readXIncludes = false;
                        await mx.readFromXmlString(doc, xmlString, '', readOptions);

                        // Update the text area with the file contents
                        if (editor) {
                            editor.setValue(xmlString);
                        }
                        else {
                            let textArea = document.getElementById('materialXTextArea');
                            textArea.value = xmlString;
                        }

                        updateNodeGraphMenu();

                    } catch (error) {
                        console.error('Error:', error);
                    }
                })();
            }

            function loadMaterialXDocument(file, fileName) {
                if (mx) {
                    // Load the content from the specified file (replace this with actual loading logic)
                    console.log("Loading content from file:", file.name);

                    const reader = new FileReader();
                    reader.readAsText(file, 'UTF-8');

                    reader.onload = function (e) {
                        // Display the contents of the file in the output div
                        let fileContents = e.target.result;
                        //console.log(e.target);

                        (async () => {
                            try {
                                const readOptions = new mx.XmlReadOptions();
                                readOptions.readXIncludes = false;
                                doc.clearContent();
                                await mx.readFromXmlString(doc, fileContents, '', readOptions);

                                // Update the text area with the file contents
                                if (editor) {
                                    editor.setValue(fileContents);
                                }
                                else {
                                    let textArea = document.getElementById('materialXTextArea');
                                    textArea.value = fileContents;
                                }

                                updateNodeGraphMenu();

                            } catch (error) {
                                console.error('Error:', error);
                            }
                        })();

                    };

                } else {
                    console.error("MaterialX is not initialized");
                }
            }

            function setupXML() {
                // Initialize CodeMirror for XML syntax highlighting
                const materialXTextArea = document.getElementById('materialXTextArea');
                editor = CodeMirror.fromTextArea(materialXTextArea, {
                    mode: 'application/xml',
                    lineNumbers: true,
                    dragDrop: true,
                    theme: 'night'
                });

                // Optional: Set an initial value for the textarea
                const initialXML = ''; //'<?xml version="1.0" encoding="utf-8"?>\r\n<materialx version="1.38" colorspace="lin_rec709">\r\n</materialx>';
                materialXTextArea.value = initialXML;
                editor.setValue(initialXML);

                // Update CodeMirror whenever the textarea content changes
                editor.on('change', () => {
                    // Copy the content from CodeMirror back to the textarea
                    materialXTextArea.value = editor.getValue();
                });
                editor.setSize('auto', '300px');
                var pasteButton = document.getElementById('materialXTextArea_paste');
                if (pasteButton)
                {
                    addPasteHandler(pasteButton, editor);
                }

                // Initialize CodeMirror for XML syntax highlighting
                const definitionArea = document.getElementById('definition_output');
                defeditor = CodeMirror.fromTextArea(definitionArea, {
                    mode: 'application/xml',
                    lineNumbers: true,
                    dragDrop: true,
                    theme: 'night'
                });
                defeditor.setSize('auto', '300px');
                defeditor.on('change', () => {
                    definitionArea.value = defeditor.getValue();
                });

                const definitionArea2 = document.getElementById('definition_output2');
                defeditor2 = CodeMirror.fromTextArea(definitionArea2, {
                    mode: 'application/xml',
                    lineNumbers: true,
                    dragDrop: true,
                    theme: 'night'
                });
                defeditor2.setSize('auto', '200px');
                defeditor2.on('change', () => {
                    definitionArea2.value = defeditor2.getValue();
                });


            }

            const useExternalHighlighting = true;
            document.addEventListener('DOMContentLoaded', () => {
                if (useExternalHighlighting) {
                    setupXML();
                }
            });

            function getPortConnection(node, port, connections) {
                let connection = null
                let downstream = node.getNamePath()
                let nodeParentPath = node.getParent().getNamePath()
                let upstream = ""
                let inputQualifier = port.getName()
                let optionalOutput = ""

                console.log('Scan node: ', downstream, '. Port: ', port.getNamePath())

                // Ugly: Look for 'nodename' or 'nodegraph' or 'interfacename' in the port
                connectorNames = ['nodename', 'nodegraph', 'interfacename']
                upstream = ""
                outputQualifier = ""
                for (let connectorName of connectorNames) {
                    upstream = port.getAttribute(connectorName)
                    if (upstream) {
                        outputName = port.getOutputString();
                        if (outputName) {
                            outputQualifier = outputName
                        }
                        break
                    }
                }
                if (upstream == "") {
                    upstream = port.getOutputString()
                }
                if (upstream && nodeParentPath != "") {
                    upstream = nodeParentPath + '/' + upstream
                }
                if (upstream) {
                    connection = [upstream, outputQualifier, downstream, inputQualifier];
                    connections.push(connection);
                    console.log('-- Found connection:', connection)
                }
            }

            function getConnection(root, connections) {
                for (let node of root.getNodes()) {
                    //console.log('Scan node:', node.getNamePath());
                    //console.log('Path:', allPaths[i]);
                    //node = doc.getDescendant(paths[i]);
                    //nodeList.push(node.getNamePath());
                    for (let input of node.getInputs()) {
                        getPortConnection(node, input, connections);
                    }
                }
                for (let output of root.getOutputs()) {
                    getPortConnection(output, output, connections);
                }
            }

            function buildGraph(doc) {
                nodeList = []
                subgraphs = []
                connections = []
                console.log('Build Graph....')
                /*let tree = doc.traverseTree();
                if (tree)
                {
                    tree.next();
                    while (tree.getElement())
                    {
                        elem = tree.getElement();
                        nodeList.push(elem.getNamePath());
                        tree.next();
                    }
                }*/
                let nodes = doc.getNodes();
                for (let node of nodes) {
                    nodeList.push(node.getNamePath());
                }
                connections = []
                getConnection(doc, connections)

                let nodegraphs = doc.getNodeGraphs();
                graph_connections = []
                for (let nodegraph of nodegraphs) {
                    let subgraph = [nodegraph.getNamePath(), []]
                    for (let graphnode of nodegraph.getNodes()) {
                        subgraph[1].push(graphnode.getNamePath());
                    }
                    for (let graphnode of nodegraph.getInputs()) {
                        subgraph[1].push(graphnode.getNamePath());
                    }
                    for (let graphnode of nodegraph.getOutputs()) {
                        subgraph[1].push(graphnode.getNamePath());
                    }
                    subgraphs.push(subgraph);
                    getConnection(nodegraph, connections);
                }

                //console.log('Nodes:', nodeList);
                //console.log('Subgraphs:', subgraphs);
                //console.log('Connections:', connections);

                let mermaidText = 'graph LR;\n';
                for (let node of nodeList) {
                    mermaidText += node + '["' + node + '"];\n';
                }
                //console.log('Nodes:', nodeList);
                if (subgraphs.length > 0) {
                    for (let subgraph of subgraphs) {
                        mermaidText += 'subgraph ' + subgraph[0] + ';\n';
                        for (let node of subgraph[1]) {
                            mermaidText += node + '["' + node + '"];\n';
                        }
                        mermaidText += 'end;\n';
                    }
                }
                for (let connection of connections) {
                    let connection_label = connection[2];
                    if (connection[1]) {
                        connection[0] += '-->' + connection[0] + '/' + connection[1] + '(' + connection[1] + ')';
                    }
                    mermaidText += connection[0] + '--"' + connection[3] + '"-->' + connection[2] + ';\n';
                }

                return mermaidText;
            }

            // Add event handler for generate graph
            document.getElementById('generateGraphButton').addEventListener('click', () => {

                let graphTextArea = document.getElementById('mermaid_input');
                let materialXTextArea = document.getElementById('materialXTextArea');

                if (materialXTextArea.value.length == 0) {
                    graphTextArea.value = 'No MaterialX document to graph.';
                    return;
                }

                console.log('Generating Graph...');
                const readOptions = new mx.XmlReadOptions();
                readOptions.readXIncludes = false;

                (async () => {
                    try {
                        const readOptions = new mx.XmlReadOptions();
                        readOptions.readXIncludes = false;
                        doc.clearContent();
                        await mx.readFromXmlString(doc, materialXTextArea.value);

                        if (!doc) {
                            graphTextArea.value = 'No MaterialX document to graph.';
                            return;
                        }

                        if (!doc.getChildren() || doc.getChildren().length == 0) {
                            graphTextArea.value = 'No MaterialX document elements found';
                            return;
                        }

                        try {
                            ;
                            /* if (!doc.validate()) {
                                graphTextArea.value = 'MaterialX document failed validation';
                                return;
                            } */
                        } catch (error) {
                            // Reject the promise if there's an error
                            graphTextArea.value = 'MaterialX document is invalid: ' + error;
                            return;
                        }

                        //console.log('Use new builder !')

                        let opts = {
                            orientation: 'LR',
                            emitCategory: false,
                            emitType: false,
                            inputFileName: ''
                        };

                        // Set the orientation from UI
                        let orientation = document.getElementById('graphOrientation').value;
                        if (orientation == 0) {
                            opts.orientation = 'LR'
                        } else {
                            opts.orientation = 'TB'
                        }

                        let labelCategories = document.getElementById('labelCategories').checked;
                        opts.emitCategory = labelCategories;

                        let labelTypes = document.getElementById('labelTypes').checked;
                        opts.emitType = labelTypes;

                        let outputList = [];
                        try {
                            let graphOutput = createMermaidGraphFromDocument(doc, opts);
                            //console.log('Graph:', graphOutput[1]);
                            graphTextArea.value = graphOutput[0];

                            let jsonOutput = graphOutput[1]
                            let jsonTextArea = document.getElementById('json_output');
                            jsonTextArea.value = jsonOutput;

                        } catch (error) {
                            // Reject the promise if there's an error
                            graphTextArea.value = 'Error generating graph: ' + error;
                        };

                        renderMermaid();

                    } catch (error) {
                        graphTextArea.value = 'Invalid XML found: ' + error;
                        return;
                    }
                })();
            });

            function saveURL(url, name) {
                var downloadLink = document.createElement("a");
                downloadLink.href = url;
                downloadLink.download = name;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }

            function createSvgBlob(elem) {
                elem.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                var svgData = elem.outerHTML;
                var preface = '<?xml version="1.0" standalone="no"?>\r\n';
                var svgBlob = new Blob([preface, svgData], { type: "image/svg+xml;charset=utf-8" });
                return svgBlob;
            }

            function resetSvgView(elem) {
                if (elem && originalViewBox) {
                    currentViewBox = elem.getAttribute('viewBox');
                    //console.log('Resetting viewbox to:\n ' + originalViewBox)
                    elem.setAttribute('viewBox', originalViewBox);
                }
                return currentViewBox;
            }

            function saveSvg(elem, name) {
                // Restore original viewBox before saving
                currentViewBox = resetSvgView(elem);

                svgBlob = createSvgBlob(elem);

                // Save to disk
                var url = URL.createObjectURL(svgBlob);
                saveURL(url, name);

                // Restore current viewBox
                if (originalViewBox) {
                    elem.setAttribute('viewBox', currentViewBox);
                }
            }

            function renderMermaid() {
                const output = document.getElementById("mermaid_output");
                const code = document.getElementById("mermaid_input").value.trim();

                let newSVG = ''
                let generateDiagram = function (code) {
                    newSVG = code;
                };

                if (code.length == 0) {
                    prevSVG = ''
                    output.innerHTML = ''
                }
                if (code) {
                    let generated = true;
                    prevSVG = output.innerHTML;
                    try {
                        mermaid.render("mermaid_output_rendered", code, generateDiagram)
                    } catch (error) {
                        generated = false
                    }

                    if (generated) {
                        output.innerHTML = newSVG;
                        prevSVG = newSVG;
                        var svgContent = document.getElementById('mermaid_output_rendered');
                        originalViewBox = svgContent.getAttribute('viewBox');
                        setUpSVGInteraction('mermaid_output', 'mermaid_output_rendered')
                    }
                    else {
                        // Clear this out so that we don't get the default Mermaid error SVG
                        mermaid_output_rendered = document.getElementById('mermaid_output_rendered');
                        if (mermaid_output_rendered) {
                            mermaid_output_rendered.innerHTML = '';
                        }
                        output.innerHTML = 'Invalid Mermaid text entered. Failed to generate graph.';
                    }
                }
            }

            // Review view of svg element
            document.getElementById("resetSVGView").addEventListener("click", (e) => {
                var svgContent = document.getElementById('mermaid_output_rendered');
                if (svgContent) {
                    resetSvgView(svgContent);
                }
            });

            // Save svg element to file
            document.getElementById("saveSVG").addEventListener("click", (e) => {
                var svgContent = document.getElementById('mermaid_output_rendered');
                if (svgContent) {
                    saveSvg(svgContent, "graph.svg");
                }
            });

            function updateNodeGraphMenu() {
                let nodeGraphsDropdown = document.getElementById('nodeGraphs');
                while (nodeGraphsDropdown.firstChild) {
                    nodeGraphsDropdown.removeChild(nodeGraphsDropdown.firstChild);
                }
                let nodeGraphs = doc.getNodeGraphs();
                for (let nodeGraph of nodeGraphs) {
                    let option = document.createElement('option');
                    option.value = nodeGraph.getName();
                    option.text = nodeGraph.getName();
                    //console.log('NodeGraph:', nodeGraph.getName());
                    nodeGraphsDropdown.appendChild(option);
                }
            }

            // Update nodegraphs on updateGraphs button click
            document.getElementById('updateGraphs').addEventListener('click', () => {
                updateNodeGraphMenu();
            });

            function createDefinition(writeToDisk) {
                let nodeGraphsDropdown = document.getElementById('nodeGraphs');
                let selectedNodeGraph = nodeGraphsDropdown.value;
                if (selectedNodeGraph) {

                    let nodeGraph = doc.getNodeGraph(selectedNodeGraph);
                    if (nodeGraph) {
                        console.log('Creation definition for nodegraph:', nodeGraph.getNamePath());

                        let creator = new MaterialXDefinitionCreator(nodeGraph);
                        let creator_options = creator.getDefaultOptions();
                        let nodegroupName = document.getElementById('nodegroupName').value;
                        if (nodegroupName) {
                            creator_options[creator.NODEGROUP] = nodegroupName;
                        }
                        let definitionName = document.getElementById('definitionName').value;
                        if (definitionName) {
                            creator_options[creator.DEFINITION_NAME] = definitionName;
                        }
                        let documentationString = document.getElementById('documentationString').value;
                        if (documentationString) {
                            // Remove any newlines
                            documentationString = documentationString.replace(/(\r\n|\n|\r)/gm, " ");
                            creator_options[creator.DOCUMENTATION] = documentationString;
                        }

                        creator.setOptions(creator_options);
                        let definitionDocument = creator.execute(nodeGraph);
                        if (definitionDocument) {
                            const writeOptions = new mx.XmlWriteOptions();
                            writeOptions.writeXIncludeEnable = false;
                            var total_result = mx.writeToXmlString(definitionDocument, writeOptions);
                            //console.log('original definition: ', result)

                            var funcGraph = mx.createDocument();
                            funcGraph.copyContentFrom(definitionDocument);
                            var fileName = 'definition';
                            for (let node of funcGraph.getNodeDefs()) {
                                fileName = node.getName();
                                funcGraph.removeChild(node.getName())
                            }
                            var result = mx.writeToXmlString(funcGraph, writeOptions);
                            //console.log('got function graphs: ', result)
                            defeditor.setValue(result);

                            for (let graph of definitionDocument.getNodeGraphs()) {
                                definitionDocument.removeChild(graph.getName())
                            }
                            result = mx.writeToXmlString(definitionDocument, writeOptions);
                            //console.log('got nodedefs: ', result)
                            defeditor2.setValue(result);

                            if (writeToDisk) {
                                fileName = fileName + '.mtlx';
                                let blob = new Blob([total_result], { type: 'text/xml' });
                                saveURL(URL.createObjectURL(blob), fileName);

                            }
                        }
                    }
                }
            }

            document.getElementById('createDefinition').addEventListener('click', () => {
                createDefinition(false);
            });
            document.getElementById('saveDefinition').addEventListener('click', () => {
                createDefinition(true);
            });

            function setupTheme() {
                const body = document.body;
                // Check if the user has a preferred color scheme
                const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

                //if (document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast'))
                // prefersDarkMode = true

                // Set the initial theme based on user preferences
                if (prefersDarkMode) {
                    body.setAttribute('data-bs-theme', 'dark');
                } else {
                    body.setAttribute('data-bs-theme', 'light');
                }

                // Setup mermarid display mode
                mermaid.initialize({
                    startOnLoad: false,
                    theme: prefersDarkMode ? 'dark' : 'base',
                    themeVariables: {
                        'primaryColor': prefersDarkMode ? '#1F1F1F' : '#F1F1F1',
                        'primaryBorderColor': prefersDarkMode ? '#FFFFFF' : '#000000',
                        'background': prefersDarkMode ? '#000000' : '#FFFFFF',
                        'secondaryColor': prefersDarkMode ? '#111100' : '#EEEEFF',
                        'tertiaryColor': prefersDarkMode ? '#111111' : '#EEEEEE'
                    }
                });
            }

            setupTheme();
            addCopyHandlers();

        </script>

    </div>
  </section>

    <footer class="bg-dark-subtle footer text-white py-2 pt-2" data-bs-theme="dark">
    <div class="container">
      <ul class="social-icons">
        <button class="btn btn-outline" type="button">
          <a href="https://github.com/kwokcb/MaterialX_Learn" target="_blank"><b class="fa-brands fa-github fa-2x"
              style="color: #ffffff;"></b></a>
        </button>
        <button class="btn btn-outline " type="button">
          <a href="https://www.linkedin.com/in/bernard-kwok/" target="_blank"><b class="fa-brands fa-linkedin-in fa-2x"
              style="color: #0082ca;"></b></a>
        </button>
      </ul>
      <p>
        <a class="bg-dark p-2 right" rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0"
                src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>
        &copy; 2022-2024 NanMu Consulting.</a>
      </p>      
    </div>
  </footer>

</body>

</html>