<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--StyleStart-->
    <title>MaterialX Graph Editor</title>

    <!-- Syntax styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <!--
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material-ocean.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/blackboard.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/nord.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/base16-dark.min.css">
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/night.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">

    <!-- Graph styles -->
    <!-- <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/litegraph.js/dist/css/litegraph.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/litegraph.js/dist/css/litegraph-editor.css"> -->
    <link rel="stylesheet" type="text/css" href="litegraph/litegraph.css">
    <link rel="stylesheet" type="text/css" href="litegraph/litegraph-editor.css">

    <style>
        /* 3D Canvas styling */
        .canvas-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            /* Aspect ratio 3:5 */
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            min-width: 64;
            min-height: 64;
            border: solid thin lightskyblue
        }

        /* Node graph canvas styling */
        .graph-canvas-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
        }


        .CodeMirror {
            font-size: 12px;
            border-radius: 2%;
            border: solid thin lightskyblue;
        }

        .copy-button,
        .paste-button {
            cursor: pointer;
            border: none;
            background: none;
        }

        .invert-colors {
            background-color: white;
            /* or any color you want for the background */
            color: black !important;
            /* or any color you want for the text */
        }

        /* Custom slider styles */
        .custom-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: grey;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 5px;
        }

        .custom-slider:hover {
            opacity: 1;
        }

        .custom-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 10px;
            cursor: pointer;
            background: grey;
            border-radius: 5px;
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: white;
            border: 2px solid black;
            cursor: pointer;
            border-radius: 50%;
            /* margin-top: -5px; Adjust margin to center thumb */
        }

        .custom-slider:focus::-webkit-slider-runnable-track {
            background: lightblue;
        }

        .custom-slider::-moz-range-track {
            width: 100%;
            height: 10px;
            cursor: pointer;
            background: grey;
            border-radius: 5px;
        }

        .custom-slider::-moz-range-thumb {
            background: white;
            border: 2px solid black;
            cursor: pointer;
            border-radius: 50%;
        }

        .custom-slider:focus::-moz-range-track {
            background: lightblue;
        }

        /* Custom CSS to handle slider value */
        /* .custom-slider {
            --slider-value: 50%;
        }

        #customRange {
            --slider-value: calc(var(--slider-value) * 1%);
        }

        #customRange:active::-webkit-slider-runnable-track {
            background: white
        } */
    </style>
    <link rel="icon" type="images" href="./Icons/logo_wave3.png" type="image/x-icon" class="img-fluid">
    <!--StyleEnd-->
</head>

<body data-bs-theme="dark">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <!--Start-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>


    <!-- Use local version for now which tweaks some UI -->
    <script src="./litegraph/litegraph.js"></script>
    <script src="./litegraph/base.js"></script>

    <div class="container-fluid p-2">

        <!-- Header -->
        <h2 class="bg-gradient p-2 rounded-4"><img class="rounded-4" src="./Icons/logo_wave3.png" width="48px">
            MaterialX Graph Editor</h2>

        <div id="materialxtoy_editor" class="container-fluid border rounded-4">

            <div class="row p-0 align-items-left justify-content-left">

                <!-- Left side graph editor -->
                <div class="col-md-8 py-0 px-1" id="colContainer">

                    <nav class="navbar navbar-expand navbar-dark bg-dark">
                        <div class="rounded-2 bg-gradient container-fluid">
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#nodGraphMenu" aria-controls="nodGraphMenu" aria-expanded="false"
                                aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="nodGraphMenu">
                                <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                                    <!---------------------- File ------------------->
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            File
                                        </a>
                                        <ul class="dropdown-menu">
                                            <!-- <li><a class="dropdown-item" id="loadSerialization">JSON Serialization</a></li> -->
                                            <!-- <li><div class="dropdown-item" id="loadMaterialXDocumentFromText">MaterialX Text</div></li> -->
                                            <li><a class="dropdown-item" id="clearGraph">Clear</a></li>
                                            <li>
                                                <div class="dropdown-item" id="loadMaterialXDocumentFromFile">Load
                                                    Document...
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="loadMaterialXDefinitions">Load
                                                    Definitions...</div>

                                                <!-- 
                                            <li>
                                                <div class="dropdown-item" id="downloadGraph">JSON Serialization</div> 
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="saveMaterialXGraphText">MaterialX Text</div>
                                            </li> 
                                            -->

                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>

                                            <li>
                                                <div class="dropdown-item" id="saveMaterialXGraph">Save Document...
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item">
                                                    <div class="form-check">
                                                        <label class="form-check-label" for="writeCustomLibs">
                                                            Include Libraries
                                                        </label>
                                                        <input class="form-check-input" type="checkbox" value="true"
                                                            id="writeCustomLibs" checked>
                                                    </div>
                                                </div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item">
                                                    <div class="form-check">
                                                        <label class="form-check-label" for="saveNodePositions">
                                                            Save Layout
                                                        </label>
                                                        <input class="form-check-input" type="checkbox" value=""
                                                            id="saveNodePositions">
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                    </li>

                                    <!---------------------- Library ------------------->
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" data-bs-auto-close='outside' role="button"
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                            Library
                                        </a>
                                        <ul id="libraryDropdown" class="dropdown-menu">
                                        </ul>
                                    </li>

                                    <!---------------------- Edit ------------------->
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            Edit
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <div class="dropdown-item" id="copySelected">Copy (CRTL-C)</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="pasteSelected">Paste (CRTL-V)</div>
                                            </li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="createNodeGraph">Create Subgraph</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="extractNodeGraph">Extract from Subgraph
                                                </div>
                                            </li>
                                        </ul>
                                    </li>

                                    <!---------------------- View ------------------->
                                    <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                            View
                                        </a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <div class="dropdown-item" id="resetView">Reset View</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="arrangeGraph">Layout Nodes (l)</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="centerNode">Center Node (f)</div>
                                            </li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="collapseNodes">Collapse Nodes</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="expandNodes">Expand Nodes</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="openSubgraph">Open Subgraph</div>
                                            </li>
                                            <li>
                                                <div class="dropdown-item" id="closeSubgraph">Close Subgraph</div>
                                            </li>
                                        </ul>
                                    </li>

                                    <li class="nav-item">
                                        <button class="btn btn-outline" id="captureGraph">Capture</button>
                                    </li>
                                </ul>

                                <!-- <form class="d-flex" role="search">
                                    <input class="form-control font-sm me-2" type="search" placeholder="Search"
                                        aria-label="Search">
                                    <button class="btn btn-sm btn-outline-success" type="submit">Search</button>
                                </form> -->

                            </div>
                        </div>
                    </nav>

                    <div class="graph-canvas-container" id="canvasContainer">
                        <canvas id="mygraphcanvas" class="rounded-4"></canvas>
                    </div>
                </div>

                <!-- Right side viewer and property panels -->
                <div id="viewer_propertypanel_column" class="col p-2">

                    <!-- Viewer Panel -->
                    <details style="display:none" id="preview_panel" open>
                        <summary class="p-1 bg-gradient rounded-2"> Viewer<p></p>
                        </summary>
                        <div class="container g-0 px-0">
                            <div class="row g-0 align-items-left py-1 px-0">
                                <div class="col">
                                    <!-- btn-outline-warning means something to update -->
                                    <button id="graphtoxml2" class="btn btn-sm btn-outline-secondary" id="mtlxdoc">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white"
                                            class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd"
                                                d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
                                            <path
                                                d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
                                        </svg>
                                        <!-- <img class="" src="./Icons/arrow_down_white.svg" style="width: 24px;"
                                            alt="Graph to Render"> -->
                                    </button>
                                    <button id="disableRendering" class="btn btn-sm btn-outline-secondary">
                                        <img class="" src="./Icons/sphere.png" style="width: 18px;"
                                            alt="Toggle Rendering">
                                    </button>
                                    <button id="turntableEnabled" class="btn btn-sm btn-outline-secondary">
                                        <img src='./Icons/play_white.svg' style="height: 18px;" alt="Toggle Turntable">
                                    </button>
                                    <!-- <button id="resetCamera" class="btn btn-sm btn-outline-secondary">
                                        <img src='/Icons/camera_reset.svg' style="height: 24px;" alt="Reset Camera">
                                    </button> -->
                                    <button id="toggleBackgroundTexture" class="btn btn-sm btn-outline-secondary">
                                        <img src='./Icons/show.svg' style="height: 18px;" alt="Toggle Background">
                                    </button>
                                    <!-- <label for="renderableItem">Renderable</label> -->
                                    <select id="renderableItem" class="form-select-sm" style="font-size: 11px;">
                                    </select>
                                    <select class="form-select-sm" id="loadGeometry" style="font-size: 11px;">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row g-0 align-items-left py-1 px-0">
                            <div class="col" id="webCanvasColumn">
                                <div class="canvas-container" id="webCanvasContainer">
                                    <canvas id="webglcanvas" tabindex=1 class="rounded-2"
                                        style="outline: none"></canvas>
                                </div>
                            </div>
                        </div>
                    </details>
                    <div class="row pt-0">
                        <details open>
                            <summary style="font-size: 12px;" class="p-1 bg-gradient rounded-2"
                                id="propertypanel_title">
                                <img id="propertypanel_icon" alt="Properties Icon" src="./Icons/nodegraph_white.svg"
                                    width="24px"> Properties
                            </summary>
                            <div id="propertypanel_content"
                                style="max-height: 720px; overflow-y: auto; overflow-x: hidden; background-color: rgb(47, 50, 54);">
                            </div>
                        </details>
                    </div>
                </div>
                <div class="row p-1 pe-0">
                    <div class="col pl-1 pe-0">
                        <textarea class="rounded pl-0 pe-0" id="console_area" rows="3"
                            style="font-size: 12px; max-height: 512px; overflow: auto; background-color: rgb(47, 50, 54); width: 100%;">
                    </textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid border rounded-4"  id="text_document_area">
            <details class="p-1" open>
                <summary>Documents</summary>
                <div class="row p-0 flex no-wrap" style="font-size: 12px">
                    <div id="materialx_area" class="col p-2">
                        <label for="mtlxdoc">MaterialX Document</label>
                        <button class="btn btn-sm copy-button" data-target="mtlxdoc">
                            <img class="" src="./Icons/copy-regular_white.svg" style="width: 18px;" alt="Copy Icon">
                        </button>
                        <button id="mtlxdoc_paste" class="btn btn-sm" data-target="mtlxdoc">
                            <img class="" src="./Icons/clipboard_white.svg" style="width: 18px;" alt="Paste Icon">
                        </button>
                        <button id="graphtoxml" class="btn btn-sm" data-target="mtlxdoc">
                            <img class="" src="./Icons/arrow_down_white.svg" style="width: 18px;" alt="Graph to XML">
                        </button>
                        <button id="xmltograph" class="btn btn-sm" data-target="mtlxdoc">
                            <img class="" src="./Icons/arrow_up_white.svg" style="width: 18px;" alt="XML to Graph">
                        </button>
                        <textarea style="background-color: black" class="overflow-auto form-control form-control-sm fs-3" id="mtlxdoc" placeholder=""
                            rows="10" width="100%">
                        </textarea>
                    </div>

                    <div id="gltf_area" class="col-6 p-2"  style="display: none">
                        <label for="gltfgraph">glTF Procedural</label>
                        <button class="btn btn-sm copy-button" data-target="gltfgraph">
                            <img class="" src="./Icons/copy-regular_white.svg" style="width: 18px;" alt="Copy Icon">
                        </button>
                        <button id="gltfgraph_paste" class="btn btn-sm" data-target="gltfgraph">
                            <img class="" src="./Icons/clipboard_white.svg" style="width: 18px;" alt="Paste Icon">
                        </button>
                        <button id="graphtogltf" class="btn btn-sm" data-target="gltfgraph">
                            <img class="" src="./Icons/arrow_down_white.svg" style="width: 18px;" alt="Graph to XML">
                        </button>

                        <button id="gltftograph" class="btn btn-sm" data-target="gltfgraph">
                            <img class="" src="./Icons/arrow_up_white.svg" style="width: 18px;" alt="XML to Graph">
                        </button>
                        <textarea style="border:solid thin lightskyblue; background-color: black"
                            class="overflow-auto form-control fs-3" id="gltfgraph" placeholder="" rows="10" width="100%">
                        </textarea>
                    </div>
                </div>
            </details>
        </div>

        <div class="container-fluid border rounded-4" id="definitions_area">

            <details class="p-1">
                <summary>Definitions</summary>
                <div class="row px-0 pb-2 pt-2" style="font-size: 12px" >
                    <div class="col p-2">
                        <label for="mtlxlib">Definition Creation Code</label>
                        <button class="btn btn-sm copy-button" data-target="mtlxlib">
                            <img class="" src="./Icons/copy-regular_white.svg" style="width: 18px;" alt="Copy Icon">
                        </button>
                        <textarea style="border:solid thin lightskyblue; background-color: black"
                            class="form-control fs-6" id="mtlxlib" placeholder="Functional Definitions" disabled
                            rows="10" width="100%">
                                    </textarea>
                    </div>
                </div>
            </details>
            <details class="p-1">
                <summary>Available Node Types</summary>
                <div style="border:solid thin lightskyblue; max-height: 300px; overflow-y: auto;">
                    <table style="font-size:11px;" class="table table-bordered">
                        <thead class="sticky-top table-light">
                            <tr>
                                <th scope="col">Graph Id</th>
                                <th scope="col">Node Definition</th>
                            </tr>
                        </thead>
                        <tbody id="nodeTypesList" class="table-dark">
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
        </details>
    </div>
    </div>

    <script type="text/javascript" src="../JsMaterialXGenShader.js"></script>
    <!-- TODO: Add logic to load from pre-built JS definitions file for those that
         want independence from MaterialX. e.g. for a glTF texture procedurals -->
    <!-- <script type="text/javascript" src="mtlx_stdlib.js"></script> -->
    <script type="text/javascript" src="../JsMaterialXglTF.js"></script>
    <script type="text/javascript" src="../JsMaterialXNodeEditor.js"></script>

    <!-- <script src="./litegraph-editor.js"></script> -->
    <!-- <script src="./base.js"></script>  -->

    <script src="ui_helpers.js"></script>
    <script type="module">
        import { MxNodeEditorPreferences } from "../node_editor_preferences.js";
        import { initializeNodeEditor } from '../node_editor.js';
        let renderer = null;
        let preferences = new MxNodeEditorPreferences();
        let materialFilename = preferences.getDefaultMaterialFile();
        let geometryFilename = preferences.getDefaultGeometryFile();
        let sampleFiles = preferences.getExamples();
        let my_icon_map = preferences.getIconMap();
        let readOnly = false;
        // Get URL option for readOnly mode
        // e.g. URL: http://localhost:8000/index.html?readOnly=true
        let readOnlyParam = new URLSearchParams(document.location.search).get("readOnly");
        if (readOnlyParam) {
            readOnly = true;
        }
        initializeNodeEditor(materialFilename, geometryFilename, renderer, my_icon_map, sampleFiles, readOnly);

        let gltf_area = document.getElementById("gltf_area");
        let mtlx_area = document.getElementById("materialx_area");
        if (mtlx_area && gltf_area)
        {
            // If gltf_area display is not none, set mtlx_area to col-6 vs col class.
            if (gltf_area.style.display != 'none')
            {
                console.log('Adust document area sizes', mtlx_area, gltf_area);
                mtlx_area.classList.remove('col');
                mtlx_area.classList.add('col-6');
            }   
        }    
    </script>
    <script>
        // Make body dark theme
        document.body.setAttribute('data-bs-theme', 'dark');
    </script>
    <!--End-->
</body>

</html>